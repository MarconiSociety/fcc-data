<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>USBB Map: Vector Tile</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

		.map-overlay {
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
		position: absolute;
		width: 25%;
		top: 0;
		left: 0;
		padding: 10px;
		}
		 
		.map-overlay .map-overlay-inner {
		background-color: #fff;
		box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
		border-radius: 3px;
		padding: 10px;
		margin-bottom: 10px;
		}
		 
		.map-overlay h2 {
		line-height: 24px;
		display: block;
		margin: 0 0 10px;
		}
		 
		.map-overlay .legend .bar {
		height: 10px;
		width: 100%;
		background: linear-gradient(to right, #FCA107, #7F3121);
		}
		 
		.map-overlay input {
		background-color: transparent;
		display: inline-block;
		width: 100%;
		position: relative;
		margin: 0;
		cursor: ew-resize;
		}

		input[type=radio] {
			display: inline-block;
		}

		.session {
		  margin-bottom: 20px;
		}

		.row {
		  height: 10px;
		  width: 100%;
		}

		.colors {
		  background: linear-gradient(to right, #2dc4b2, #3bb3c3, #669ec4, #8b88b6, #a2719b, #aa5e79, #2dc4b2);
		  margin-bottom: 5px;
		}

		.label {
		  width: 15%;
		  display: inline-block;
		  text-align: center;
		}
		#console {
		  position: absolute;
		  width: 240px;
		  margin: 10px;
		  padding: 10px 20px;
		  background-color: white;
		}

    </style>
</head>
<body>

<div id='map'></div>

<div class='map-overlay top'>
	<div class='map-overlay-inner'>
		<h2>United States of Broadband</h2>
		Area: <select id="geo" name="geo">
		  <option value="county">County</option>
		  <option value="congress">Congressional Districts</option>
		  <option value="state_house">State House</option>
		  <option value="state_senate">State Senate</option>
		  <!-- <option value="census_tract">Census Tract</option>
		  <option value="zcta">Zip Code</option> -->
		</select>

		<br/>

		State: <select id="state_select" name="state_select">
		</select>

		<br/>

		Dataset: <select id="data" name="data">
		  <option value="mlab" id="mlab">Measurement Lab</option>
		  <option value="fcc" id="fcc">FCC 477</option>
		  <!-- <option value="nn_state_bills">Net Neutrality Bills by State</option>  -->
		</select>

		<br/>
		Time Period: <label id='time_period'></label>
		<input id='slider' type='range' min='0' max='8' step='1' value='8' />

		Measurement: <select id="measurement" name="measurement">
		  <!-- <option value="dl_bb_cutoffs">Download Broadband Cutoffs</option>
		  <option value="ul_bb_cutoffs">Upload Broadband Cutoffs</option> -->
		  <optgroup label="M-Lab" id="mlab">
		  <option value="download_Mbps_">Download Median (Mbps)</option>
		  <option value="upload_Mbps_">Upload Median (Mbps)</option>
		  <option value="min_rtt_">RTT</option>
		  <option value="dl_count_tests_">Download Tests (count)</option>
		  <option value="ul_count_tests_">Upload Tests (count)</option>
		  <option value="dl_count_ips_">Download IPs (count)</option>
		  <option value="ul_count_ips_">Upload IPs (count)</option>
		  </optgroup>
		  <optgroup label="FCC Data" id="fcc">
		  <option value="advertised_down_">Advertised Download Median (Mbps)</option>
		  <option value="advertised_up_">Advertised Upload Median (Mbps)</option>
		  </optgroup>
		</select>

	</div>
	
	<div class='map-overlay-inner' >
		<div class='session'>
		  <h3>Data Range</h3>
		  Units: (Mbps)
		  <div id='legend' class='row colors'>
		  </div>
		  <div id="legendlabel" class='row labels'>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		  </div>
		</div>
	</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    zoom: 4,
    center: [-97.754807, 38.674870]
});

var time_periods = [['dec_2014','Dec 2014'],
					['jun_2015','Jun 2015'],
					['dec_2015','Dec 2015'],
					['jun_2016','Jun 2016'],
					['dec_2016','Dec 2016'],
					['jun_2017','Jun 2017'],
					['dec_2017','Dec 2017'],
					['jun_2018','Jun 2018'],
					['dec_2018','Dec 2018']];

var states = ["All States","Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "District of Columbia", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"];

var states_centers = [
	["All States", [38.526600, -96.726486, 3]],
	["Alabama", [32.806671, -86.791130, 5]],
    ["Alaska", [61.370716, -152.404419, 3]],
    ["Arizona", [33.729759, -111.431221, 5]],
    ["Arkansas", [34.969704, -92.373123, 5]],
    ["California", [36.116203, -119.681564, 5]],
    ["Colorado", [39.059811, -105.311104, 5]],
    ["Connecticut", [41.597782, -72.755371, 5]],
    ["Delaware", [39.318523, -75.507141, 6]],
    ["District of Columbia", [38.897438, -77.026817, 5]],
    ["Florida", [27.766279, -81.686783, 5]],
    ["Georgia", [33.040619, -83.643074, 5]],
    ["Hawaii", [21.094318, -157.498337, 5]],
    ["Idaho", [44.240459, -114.478828, 5]],
    ["Illinois", [40.349457, -88.986137, 5]],
    ["Indiana", [39.849426, -86.258278, 5]],
    ["Iowa", [42.011539, -93.210526, 5]],
    ["Kansas", [38.526600, -96.726486, 5]],
    ["Kentucky", [37.668140, -84.670067, 5]],
    ["Louisiana", [31.169546, -91.867805, 5]],
    ["Maine", [44.693947, -69.381927, 5]],
    ["Maryland", [39.063946, -76.802101, 5]],
    ["Massachusetts", [42.230171, -71.530106, 5]],
    ["Michigan", [43.326618, -84.536095, 5]],
    ["Minnesota", [45.694454, -93.900192, 5]],
    ["Mississippi", [32.741646, -89.678696, 5]],
    ["Missouri", [38.456085, -92.288368, 5]],
    ["Montana", [46.921925, -110.454353, 5]],
    ["Nebraska", [41.125370, -98.268082, 5]],
    ["Nevada", [38.313515, -117.055374, 5]],
    ["New Hampshire", [43.452492, -71.563896, 5]],
    ["New Jersey", [40.298904, -74.521011, 5]],
    ["New Mexico", [34.840515, -106.248482, 5]],
    ["New York", [42.165726, -74.948051, 5]],
    ["North Carolina", [35.630066, -79.806419, 5]],
    ["North Dakota", [47.528912, -99.784012, 5]],
    ["Ohio", [40.388783, -82.764915, 5]],
    ["Oklahoma", [35.565342, -96.928917, 5]],
    ["Oregon", [44.572021, -122.070938, 5]],
    ["Pennsylvania", [40.590752, -77.209755, 6]],
    ["Rhode Island", [41.680893, -71.511780, 6]],
    ["South Carolina", [33.856892, -80.945007, 5]],
    ["South Dakota", [44.299782, -99.438828, 5]],
    ["Tennessee", [35.747845, -86.692345, 5]],
    ["Texas", [31.054487, -97.563461, 5]],
    ["Utah", [40.150032, -111.862434, 5]],
    ["Vermont", [44.045876, -72.710686, 5]],
    ["Virginia", [37.769337, -78.169968, 5]],
    ["Washington", [47.400902, -121.490494, 5]],
    ["West Virginia", [38.491226, -80.954453, 5]],
    ["Wisconsin", [44.268543, -89.616508, 5]],
    ["Wyoming", [42.755966, -107.302490], 5]];

var ramps = {
	'download_Mbps_': [0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'],
	'upload_Mbps_': [0, '#fff',
				5, '#EED322',
				10, '#E6B71E',
				20, '#B86B25',
				30, '#8B4225',
				50, '#723122'],
	'min_rtt_': [0, '#fff',
				25, '#EED322',
				50, '#E6B71E',
				75, '#B86B25',
				100, '#8B4225',
				300, '#723122'],
	'dl_count_tests_': [100, '#fff',
				500, '#EED322',
				1000, '#E6B71E',
				5000, '#B86B25',
				10000, '#8B4225',
				25000, '#723122'],
	'ul_count_tests_': [100, '#fff',
				500, '#EED322',
				1000, '#E6B71E',
				5000, '#B86B25',
				10000, '#8B4225',
				25000, '#723122'],
	'dl_count_ips_': [100, '#fff',
				500, '#EED322',
				1000, '#E6B71E',
				5000, '#B86B25',
				10000, '#8B4225',
				25000, '#723122'],
	'ul_count_ips_': [100, '#fff',
				500, '#EED322',
				1000, '#E6B71E',
				5000, '#B86B25',
				10000, '#8B4225',
				25000, '#723122'],
	'advertised_down_': [0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'],
	'advertised_up_': [0, '#fff',
				5, '#EED322',
				10, '#E6B71E',
				20, '#B86B25',
				30, '#8B4225',
				50, '#723122'],
	'state_select':['#60af83'],
	'dl_bb_cutoffs': [0, '#fff',
				10, '#EED322'],
	'ul_bb_cutoffs': [0, '#fff',
				1, '#EED322'],
};

function makeColorRamp(){
		
		var measureGroup = document.getElementById('measurement');
		var dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;
		var geo_layer = dataset + '_' + document.getElementById('geo').value;
		var time_period = time_periods[document.getElementById('slider').value];
		var measure = document.getElementById('measurement').value;
		var state = document.getElementById('state_select').value;
		
		if( dataset == 'fcc'){
			var field = dataset + '_' + measure + time_period[0];

		}
		if( dataset == 'mlab' ){
			var field = 'ml_' + measure + time_period[0];

		}
		else{
			dataset == 'nn';
		}

		var ramp =	[ 'interpolate',
			['linear'],
			['get', field],
		];

		ramp = ramp.concat(ramps[measure]);

		//update map colors
		map.setPaintProperty(geo_layer,'fill-color',ramp);

		var legend_values = ramps[measure];

		let cssRamp	= "";
        for(var i=1; i<legend_values.length; i+=2){
        	cssRamp = cssRamp + "," + legend_values[i];
        }
        cssRamp = 'linear-gradient(to right' + cssRamp + ')';
		
        //update legend colors
		document.getElementById('legend').style.background = cssRamp;

        let cssLabels = [];
        for(var i=0; i<legend_values.length; i+=2){
        	cssLabels.push(legend_values[i]);
        }

		//update legend values
		var c = document.getElementById('legendlabel').children;
		for (var l in cssLabels) {
		    c[l].innerHTML = cssLabels[l];
		}

		//show one layer
		for( let lyr of ['mlab_zcta','mlab_county','mlab_census_tract','mlab_state_senate','mlab_state_house','mlab_congress','fcc_census_tract','fcc_county','mlab_nn_state_bills','us_states']){
			map.setLayoutProperty(lyr,'visibility','none');
		};
		map.setLayoutProperty(geo_layer,'visibility','visible');
		
		//filter out nulls
		var filter = ["has",field];
		map.setFilter(geo_layer,filter);

		// Set the label to the month
		document.getElementById('time_period').textContent = time_period[1];
}


map.on('load', function () {

	// add states to selector
	 var c = document.getElementById('state_select');
	 for (var s in states) {
	     var option = document.createElement('option');
	     option.value = states[s];
	     option.innerHTML = states[s];
	     c.appendChild(option);
	 }

    map.addLayer({
        "id": "mlab_county",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.d02bt0xr'
        },
        "source-layer": "mlab_county_2014_2018_429",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_zcta",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.btyk5r79'
        },
        "source-layer": "mlab_zcta_2014_2018_0430",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_census_tract",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.5l0a8uxx'
        },
        "source-layer": "mlab_census_tracts_2014_2018_0430",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_state_senate",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.cnjwiilp'
        },
        "source-layer": "mlab_statesenate_2014_2018_0430",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_state_house",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.8un1iy50'
        },
        "source-layer": "mlab_state_house_2014_2018_0430",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_congress",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.adctm77h'
        },
        "source-layer": "mlab_stats_by_congress_district",
        "filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "paint": {
            "fill-opacity": 0.7,
            //"fill-outline-color": '#000',
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'ml_download_Mbps_dec_2018'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "mlab_nn_state_bills",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.cjv9o72qc0emy2rk1wfh1b3mm-4fzkl'
        },
        //"filter": ["has",'ml_download_Mbps_dec_2018'],
        "layout": {
			'visibility': 'visible'
			},
        "source-layer": "nn_state_bills",
        "paint": {
            "fill-color": "#60af83",
            "fill-opacity": 0.3
        }
    });

    map.addLayer({
        "id": "fcc_census_tract",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.ale67zb4'
        },
        "filter": ["has",'fcc_advertised_down_jun_2017'],
        "layout": {
			'visibility': 'visible'
			},
        "source-layer": "fcc477_ct_json",
        "paint": {
            "fill-opacity": 0.7,
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'fcc_advertised_down_jun_2017'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "fcc_county",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.2lyzr0wd'
        },
        "filter": ["has",'fcc_advertised_down_jun_2017'],
        "layout": {
			'visibility': 'visible'
			},
        "source-layer": "fcc_477_county_2014_2017_0515",
        "paint": {
            "fill-opacity": 0.7,
            "fill-color": [
				'interpolate',
				['linear'],
				['get', 'fcc_advertised_down_jun_2017'],
				0, '#fff',
				10, '#EED322',
				25, '#E6B71E',
				50, '#B86B25',
				75, '#8B4225',
				100, '#723122'
				]
        }
    });

    map.addLayer({
        "id": "us_states",
        "type": "fill",
        "source": {
            type: 'vector',
            url: 'mapbox://newamerica.cjvopv39u05jt2wmna9mg5wz4-7j8om'
        },
        "layout": {
			'visibility': 'visible'
			},
        "source-layer": "us_states",
        "paint": {
            "fill-color": "#60af83",
            "fill-opacity": 0.3
        }
    });


    // When a click event occurs on a feature in the states layer, open a popup at the
	// location of the click, with description HTML from its properties.

	var popup = new mapboxgl.Popup();

	map.on('click', function (e) {
		 let f = map.queryRenderedFeatures(e.point);
		// if (f.length) {
		// 	showPopup(f[0]);
		// }
			
		popup.setLngLat(e.lngLat)
			.setHTML(
				'<h2>' + f[0].properties['county_name'] +'</h2>' +
				'<em>Source:'+ document.getElementById('data').value + '</em>'+ 					  
				'<table style="width:100%"><tr><th>Download Speeds</th><th>Upload Speed</th></tr>' +
					'<tr><td>'+
				'<strong>Dec 2014: </strong> ' + (f[0].properties['ml_download_Mbps_dec_2014']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2015: </strong> ' + (f[0].properties['ml_download_Mbps_jun_2015']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2015: </strong> ' + (f[0].properties['ml_download_Mbps_dec_2015']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2016: </strong> ' + (f[0].properties['ml_download_Mbps_jun_2016']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2016: </strong> ' + (f[0].properties['ml_download_Mbps_dec_2016']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2017: </strong> ' + (f[0].properties['ml_download_Mbps_jun_2017']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2017: </strong> ' + (f[0].properties['ml_download_Mbps_dec_2017']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2018: </strong> ' + (f[0].properties['ml_download_Mbps_jun_2018']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2018: </strong> ' + (f[0].properties['ml_download_Mbps_dec_2018']).toFixed(2) + ' Mbps <br/>' +
					
					'</td><td>' +

				'<strong>Dec 2014: </strong> ' + (f[0].properties['ml_upload_Mbps_dec_2014']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2015: </strong> ' + (f[0].properties['ml_upload_Mbps_jun_2015']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2015: </strong> ' + (f[0].properties['ml_upload_Mbps_dec_2015']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2016: </strong> ' + (f[0].properties['ml_upload_Mbps_jun_2016']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2016: </strong> ' + (f[0].properties['ml_upload_Mbps_dec_2016']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2017: </strong> ' + (f[0].properties['ml_upload_Mbps_jun_2017']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2017: </strong> ' + (f[0].properties['ml_upload_Mbps_dec_2017']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Jun 2018: </strong> ' + (f[0].properties['ml_upload_Mbps_jun_2018']).toFixed(2) + ' Mbps <br/>' +
				'<strong>Dec 2018: </strong> ' + (f[0].properties['ml_upload_Mbps_dec_2018']).toFixed(2) + ' Mbps <br/>' +

				'</td></tr></tr></table>'
				)
			.addTo(map);
	});
	 
	// Change the cursor to a pointer when the mouse is over the states layer.
	map.on('mouseenter', 'mlab_county', function () {
		map.getCanvas().style.cursor = 'pointer';
	});
	 
	// Change it back to a pointer when it leaves.
	map.on('mouseleave', 'mlab_county', function () {
		map.getCanvas().style.cursor = '';
	});


	// Read settings from URL, if any.
	// :dataset/:geo/:timeperiod/:measure/:x/:y/:z
	let fragment = window.location.hash;
	if (fragment) {
		const check = (v, test) => test(v) ? v : undefined;

		const measureGroup = document.getElementById('measurement');
		const dataset1 = measureGroup.options;
		console.log(dataset1);

		const datasetNames = Array.from(document.querySelectorAll("#data option")).map(el => el.value);
		console.log(datasetNames);

		const geoNames = Array.from(document.querySelectorAll("#geo option")).map(el => el.value);
		const parts = fragment.slice(1).split("/");
		const dataset = check(parts[0], (v) => datasetNames.indexOf(v) >= 0);
		const geo = check(parts[1], (v) => geoNames.indexOf(v) >= 0);
		const timeperiod = check(parts[2], (v) => time_periods.findIndex((x) => x[0] == v) >= 0);
		const measure = check(parts[3], (v) => v in ramps);
		const x = check(Number(parts[4]), (v) => !Number.isNaN(v));
		const y = check(Number(parts[5]), (v) => !Number.isNaN(v));
		const z = check(Number(parts[6]), (v) => !Number.isNaN(v));

		if (dataset) {
			document.querySelector(`#data [value='${dataset}']`).selected = true;
		}
		if (geo) {
			document.querySelector(`#geo [value='${geo}']`).selected = true;
		}
		if (timeperiod !== undefined) {
			document.getElementById('slider').value = time_periods.findIndex((x) => x[0] == timeperiod);
		}
		if (measure) {
			document.querySelector(`#measurement [value='${measure}']`).selected = true;
		}
		if ([x,y,z].every(n => n !== undefined)) {
			map.jumpTo({ center: [x, y], zoom: z });
		}
	}

  // Encode the map state into the fragment for linkability.  Keep this in sync with the block above.
  function updateFragment() {
		const dataset = document.getElementById("data").value;
		const geo = document.getElementById("geo").value;
		const timeperiod = time_periods[document.getElementById("slider").value][0];
		const measure = document.getElementById("measurement").value;
		const { lng: x, lat: y } = map.getCenter();
		const z = map.getZoom();
		const url = new URL(window.location);
		url.hash = `#${dataset}/${geo}/${timeperiod}/${measure}/${x}/${y}/${z}`;
		window.history.replaceState(undefined, 'USBB', url.toString());
	}

	// Run the color ramp to start
	makeColorRamp();
	
	// change things based on selection in the legend
	document.getElementById('slider').addEventListener('input', function(e) { makeColorRamp(); updateFragment() });
	document.getElementById('measurement').addEventListener('input', function(e) { makeColorRamp(); updateFragment() });
	document.getElementById('geo').addEventListener('input', function(e) { makeColorRamp(); updateFragment() });
	document.getElementById('data').addEventListener('input', function(e) { makeColorRamp(); updateFragment() });
	
	//flyto
	document.getElementById('state_select').addEventListener('input', function(e) { 
	// Fly to a random location by offsetting the point -74.50, 40
	// by up to 5 degrees.
		
		let active_state = document.getElementById('state_select').value;

	    for (var i = 0; i < states_centers.length; i++) {
	        // This if statement depends on the format of your array
	        if (states_centers[i][0] == active_state) {
	            //console.log(states_centers[i][1]);
	            fly_to_loc = states_centers[i][1];
	        }
	    }


		map.flyTo({
	        center: [
	            fly_to_loc[1],
	            fly_to_loc[0]
	        ],
	        zoom: fly_to_loc[2],
	        speed: .5
    	});

	 });

	map.on('moveend', updateFragment);
});
</script>

</body>
</html>