<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>USBB Map: Vector Tile</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

		.map-overlay {
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
		position: absolute;
		top: 0;
		left: 0;
		padding: 10px;
		}
		 
		.map-overlay .map-overlay-inner, .map-overlay .citation {
		background-color: #fff;
		box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
		border-radius: 3px;
		padding: 10px;
		margin-bottom: 10px;
		}

		.map-overlay .map-overlay-inner input {
			display: block;
		} 
		.map-overlay h2 {
		line-height: 24px;
		display: block;
		margin: 0 0 10px;
		}
		 
		.map-overlay .legend .bar {
		height: 10px;
		width: 100%;
		background: linear-gradient(to right, #FCA107, #7F3121);
		}
		 
		.map-overlay input {
		background-color: transparent;
		display: block;
		width: auto;
		position: relative;
		margin: 0;
		cursor: ew-resize;
		}

		.map-overlay input#slider {
			width: 100%;
		}

		.map-overlay label {
			display: block;
		}

		input[type=radio] {
			display: inline-block;
		}

		.session {
		  margin-bottom: 20px;
		}

		.row {
		  height: 10px;
		  width: 100%;
		}

		.colors {
		  background: linear-gradient(to right, #2dc4b2, #3bb3c3, #669ec4, #8b88b6, #a2719b, #aa5e79, #2dc4b2);
		  margin-bottom: 5px;
		}

		#legendlabel {
			display: flex;
			/* flex-direction: rows; */
		}

		.label {
		  display: inline-block;
		  flex: 1;
		  text-align: center;
		}
		#console {
		  position: absolute;
		  width: 240px;
		  margin: 10px;
		  padding: 10px 20px;
		  background-color: white;
		}
		.report {
			display: grid;
			grid-template-columns: repeat(4, auto);
			grid-column-gap: 0.5em;
		}
		.report-header {
			grid-column: span 2;
			font-weight: bold;
			border-bottom: 1px solid black;
		}
		.report-value {
			text-align: end;
		}
		.report-key {
			text-align: end;
		}

		.citation{
			max-width: 20em;
			max-height: 15em;
			overflow: scroll;
		}

		details {
			padding-left: 2em;
			padding-right: 2em;
			max-width: 18em;
		}

		summary {
			position: relative;
			left: -2em;
		}
    </style>
</head>
<body>

<div id='map'></div>

<div class='map-overlay top'>
	<div class='map-overlay-inner'>
		<h2>United States of Broadband</h2>
		<label for="measurement">Data <abbr title="Choose the measurement to show on the map.">?</abbr></label>
		<select id="measurement" name="measurement">
		</select>
		<div style="width:100%;">
		<details>
			<summary>Sources & Data Notes:</summary>
				<strong><a href="https://www.fcc.gov/general/broadband-deployment-data-fcc-form-477">FCC 477</a></strong> data represents the advertized speeds as reported by the ISPs for a given census tract, if the ISP could service 1 household in that census tract. To provide a unified value for the census tract, we have taken all of the advertized speeds available, and shown the median value based on the speeds reported from the ISPs. <br /><br />
				<strong><a href="https://www.measurementlab.net/tests/ndt/">M-Lab NDT</a></strong> data are Network Diagnostic Tool (NDT) measurements gathered from internet users running NDT against M-Lab servers. The data are aggregated into the reporting time periods for the FCC 477 data.
		</details>
		</div>
		<label for="geo">Area <abbr title="Choose the detail level of the places on the map.">?</abbr></label> 
		<select id="geo" name="geo">
		</select>
		<label for="slider">Time Period <abbr title="Choose the time period to show on the map.">?</abbr></label>
		<label id='time_period'></label>
		<input id='slider' type='range' />
		<label for="state_select">Zoom to State <abbr title="Center the map on a specific state.">?</abbr></label>
		<select id="state_select" name="state_select">
		</select>

		<div class='session'>
		  <h3>Data Range</h3>
		  Units: (Mbps)
		  <div id='legend' class='row colors'>
		  </div>
		  <div id="legendlabel" class='row labels'>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		    <div class='label'>0</div>
		  </div>
		</div>
	</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/newamerica/cjpn4e4df2gak2rp7nef3am21',
    zoom: 4,
    center: [-97.754807, 38.674870]
});

// The function that will be called when the user clicks on the map.  The feature under the mouse is passed in.
var popupFn;

	function mlabPopupFn(props) {
		function rate(key) {
			if (key in props) {
				return `${props[key].toFixed(2)} Mbps`;
			} else {
				return '[No results]';
			}
		}
		const rows = [
			["Dec 2014", "ml_download_Mbps_dec_2014", "ml_upload_Mbps_dec_2014"],
			["Jun 2015", "ml_download_Mbps_jun_2015", "ml_upload_Mbps_jun_2015"],
			["Dec 2015", "ml_download_Mbps_dec_2015", "ml_upload_Mbps_dec_2015"],
			["Jun 2016", "ml_download_Mbps_jun_2016", "ml_upload_Mbps_jun_2016"],
			["Dec 2016", "ml_download_Mbps_dec_2016", "ml_upload_Mbps_dec_2016"],
			["Jun 2017", "ml_download_Mbps_jun_2017", "ml_upload_Mbps_jun_2017"],
			["Dec 2017", "ml_download_Mbps_dec_2017", "ml_upload_Mbps_dec_2017"],
			["Jun 2018", "ml_download_Mbps_jun_2018", "ml_upload_Mbps_jun_2018"],
			["Dec 2018", "ml_download_Mbps_dec_2018", "ml_upload_Mbps_dec_2018"],
		];
		const formatRow = ([time, dl_key, ul_key]) =>
			`<div class="report-label">${time}</div><div class="report-value">${rate(dl_key)}</div>` +
			`<div class="report-label">${time}</div><div class="report-value">${rate(ul_key)}</div>`;

		var measureGroup = document.getElementById('measurement');
		var dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;

		return ('<h2>' + (props['county_name'] || props['tract_name'] || props['name']) + '</h2>' +
			'<em>Source:' + dataset + '</em>' +
			'<div class="report">' +
			'<div class="report-header">Download Speeds</div><div class="report-header">Upload Speeds</div>' +
			rows.map(formatRow).join('\n') +
			'</div>'
		);
	}

	function fccPopupFn(props) {
		function rate(key) {
			if (key in props) {
				return `${props[key].toFixed(2)} Mbps`;
			} else {
				return '[No results]';
			}
		}
		const rows = [
			["Dec 2014", "fcc_advertised_down_dec_2014", "fcc_advertised_up_dec_2014"],
			["Jun 2015", "fcc_advertised_down_jun_2015", "fcc_advertised_up_jun_2015"],
			["Dec 2015", "fcc_advertised_down_dec_2015", "fcc_advertised_up_dec_2015"],
			["Jun 2016", "fcc_advertised_down_jun_2016", "fcc_advertised_up_jun_2016"],
			["Dec 2016", "fcc_advertised_down_dec_2016", "fcc_advertised_up_dec_2016"],
			["Jun 2017", "fcc_advertised_down_jun_2017", "fcc_advertised_up_jun_2017"],
		];
		const formatRow = ([time, dl_key, ul_key]) =>
			`<div class="report-label">${time}</div><div class="report-value">${rate(dl_key)}</div>` +
			`<div class="report-label">${time}</div><div class="report-value">${rate(ul_key)}</div>`;

		var measureGroup = document.getElementById('measurement');
		var dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;

		return ('<h2>' + (props['county_name'] || props['tract_name'] || props['name'] || props['NAME']) + '</h2>' +
			'<em>Source:' + dataset + '</em>' +
			'<div class="report">' +
			'<div class="report-header">Download Speeds</div><div class="report-header">Upload Speeds</div>' +
			rows.map(formatRow).join('\n') +
			'</div>'
		);
	}

	function diffPopupFn(props){
		function rate(key1,key2) {
			if (key1 in props && key2 in props) {
				let diff = props[key1]-props[key2];
				return `${diff.toFixed(2)} Mbps`;
			} else {
				return '[No results]';
			}
		}
		const rows = [
			["Dec 2014", "fcc_advertised_down_dec_2014", "ml_download_Mbps_dec_2014", "fcc_advertised_up_dec_2014", "ml_upload_Mbps_dec_2014"],
			["Jun 2015", "fcc_advertised_down_jun_2015", "ml_download_Mbps_jun_2015", "fcc_advertised_up_jun_2015", "ml_upload_Mbps_jun_2015"],
			["Dec 2015", "fcc_advertised_down_dec_2015", "ml_download_Mbps_dec_2015", "fcc_advertised_up_dec_2015", "ml_upload_Mbps_dec_2015"],
			["Jun 2016", "fcc_advertised_down_jun_2016", "ml_download_Mbps_jun_2016", "fcc_advertised_up_jun_2016", "ml_upload_Mbps_jun_2016"],
			["Dec 2016", "fcc_advertised_down_dec_2016", "ml_download_Mbps_dec_2016", "fcc_advertised_up_dec_2016", "ml_upload_Mbps_dec_2016"],
			["Jun 2017", "fcc_advertised_down_jun_2017", "ml_download_Mbps_jun_2017", "fcc_advertised_up_jun_2017", "ml_upload_Mbps_jun_2017"]
		];
		const formatRow = ([time, dl_key_fcc, dl_key_mlab, ul_key_fcc, ul_key_mlab]) =>
			`<div class="report-label">${time}</div><div class="report-value">${rate(dl_key_fcc,dl_key_mlab)}</div>` +
			`<div class="report-label">${time}</div><div class="report-value">${rate(ul_key_fcc,ul_key_mlab)}</div>`;

		var measureGroup = document.getElementById('measurement');
		var dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;

		return ('<h2>' + (props['county_name'] || props['tract_name'] || props['name'] || props['NAME']) + '</h2>' +
			'<em>Source:' + dataset + '</em>' +
			'<div class="report">' +
			'<div class="report-header">Download Difference</div><div class="report-header">Upload Difference</div>' +
			rows.map(formatRow).join('\n') +
			'</div>'
		);
	}

	var config = {
		time_periods: // time periods, as an array of [internalName, displayName]
			[['dec_2014', 'Dec 2014'],
			['jun_2015', 'Jun 2015'],
			['dec_2015', 'Dec 2015'],
			['jun_2016', 'Jun 2016'],
			['dec_2016', 'Dec 2016'],
			['jun_2017', 'Jun 2017'],
			['dec_2017', 'Dec 2017'],
			['jun_2018', 'Jun 2018'],
			['dec_2018', 'Dec 2018']],
		state_centers: // jump-to-state info, an array of [displayName, [lon, lat, zoom]]
			[
				["All States", [38.526600, -96.726486, 3]],
				["Alabama", [32.806671, -86.791130, 6]],
				["Alaska", [61.370716, -152.404419, 3]],
				["Arizona", [33.96, -112.93, 5]],
				["Arkansas", [34.969704, -92.373123, 5]],
				["California", [37.56, -120.70, 5]],
				["Colorado", [38.96, -106.95, 5.5]],
				["Connecticut", [41.597782, -72.755371, 5]],
				["Delaware", [39.318523, -75.507141, 7]],
				["District of Columbia", [38.897438, -77.026817, 10]],
				["Florida", [27.766279, -84.40, 5]],
				["Georgia", [33.040619, -83.643074, 5]],
				["Hawaii", [21.094318, -157.498337, 5]],
				["Idaho", [44.240459, -114.478828, 5]],
				["Illinois", [40.349457, -88.986137, 5]],
				["Indiana", [39.849426, -86.258278, 5]],
				["Iowa", [42.011539, -93.210526, 5]],
				["Kansas", [38.526600, -96.726486, 5]],
				["Kentucky", [37.668140, -84.670067, 5]],
				["Louisiana", [31.169546, -91.867805, 5]],
				["Maine", [45.33, -69.48, 6]],
				["Maryland", [39.063946, -76.802101, 5]],
				["Massachusetts", [42.230171, -71.530106, 5]],
				["Michigan", [43.326618, -87.40, 5.5]],
				["Minnesota", [45.694454, -93.900192, 5]],
				["Mississippi", [32.741646, -89.678696, 6]],
				["Missouri", [38.456085, -92.288368, 5]],
				["Montana", [46.921925, -110.454353, 5]],
				["Nebraska", [41.125370, -98.268082, 5]],
				["Nevada", [38.313515, -117.055374, 5]],
				["New Hampshire", [43.452492, -71.563896, 5]],
				["New Jersey", [40.298904, -74.521011, 5]],
				["New Mexico", [34.840515, -106.248482, 5]],
				["New York", [42.165726, -74.948051, 5]],
				["North Carolina", [35.630066, -79.806419, 5]],
				["North Dakota", [47.528912, -99.784012, 5]],
				["Ohio", [40.388783, -82.764915, 5]],
				["Oklahoma", [35.565342, -96.928917, 5]],
				["Oregon", [44.572021, -122.070938, 5]],
				["Pennsylvania", [40.70, -78.78, 6]],
				["Puerto Rico", [18.155, -66.6963, 7]],
				["Rhode Island", [41.680893, -71.511780, 7]],
				["South Carolina", [33.856892, -80.945007, 5]],
				["South Dakota", [44.299782, -99.438828, 5]],
				["Tennessee", [35.747845, -86.692345, 5]],
				["Texas", [31.054487, -101.33, 5]],
				["Utah", [40.150032, -111.862434, 5]],
				["Vermont", [44.045876, -72.710686, 5]],
				["Virginia", [37.769337, -78.169968, 5]],
				["Washington", [47.400902, -121.490494, 5]],
				["West Virginia", [38.491226, -80.954453, 5]],
				["Wisconsin", [44.268543, -89.616508, 5]],
				["Wyoming", [42.755966, -107.302490], 5]],
		geo_units: // Array of dynamic layer info, [displayName, layerId, layerSrc, internalLayerName]
			[
				['County', 'county', 'mapbox://newamerica.usbb_county', 'usbb_county'],
				['Zip Code', 'zcta', 'mapbox://newamerica.usbb_zcta', 'usbb_zcta'],
				// ['US Census Tracts', 'census_tracts', 'mapbox://newamerica.usbb_census_tract', 'usbb_census_tract'],
				['Senate Districts', 'state_senate', 'mapbox://newamerica.usbb_state_senate', 'usbb_state_senate'],
				['House Districts', 'state_house', 'mapbox://newamerica.usbb_state_house', 'usbb_state_house'],
			],
		ramps: // Array of display styling info, {displayName, internalName, mapboxGlStyleFn, popupFn}
			[{
				displayName: 'MLab Median Download',
				internalName: 'mlab_download_Mbps',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_download_Mbps_${timePeriod}`], 
						-Infinity, '#fff',
						0.2, '#ffff5e',
						4, '#EED322',
						10, '#E6B71E',
						25, '#B86B25',
						50, '#8B4225',
						100, '#723122'
					];
				}
			}, {
				displayName: 'MLab Median Upload',
				internalName: 'mlab_upload_Mbps',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_upload_Mbps_${timePeriod}`], -Infinity, '#fff',
						0.2, '#ffff91',
						1, '#ffff5e',
						3, '#EED322',
						5, '#E6B71E',
						10, '#B86B25',
						25, '#8B4225',
						50, '#723122',
						100, '#612717'];
				}
			}, {
				displayName: 'MLab Median RTT',
				internalName: 'mlab_min_rtt',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_min_rtt_${timePeriod}`], 0, '#723122',
						5, '#8B4225',
						10, '#B86B25',
						25, '#E6B71E',
						50, '#EED322',
						100, '#ffff5e',
						300, '#fff'];
				}
			}, {
				displayName: 'MLab Download Test Count',
				internalName: 'mlab_dl_count_tests',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_dl_count_tests_${timePeriod}`], 100, '#fff',
						500, '#EED322',
						1000, '#E6B71E',
						5000, '#B86B25',
						10000, '#8B4225',
						25000, '#723122'];
				}
			}, {
				displayName: 'MLab Upload Test Count',
				internalName: 'mlab_ul_count_tests',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_ul_count_tests_${timePeriod}`], 100, '#fff',
						500, '#EED322',
						1000, '#E6B71E',
						5000, '#B86B25',
						10000, '#8B4225',
						25000, '#723122'];
				}
			}, {
				displayName: 'MLab Unique Download IPs',
				internalName: 'mlab_dl_count_ips',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_dl_count_ips_${timePeriod}`], 100, '#fff',
						500, '#EED322',
						1000, '#E6B71E',
						5000, '#B86B25',
						10000, '#8B4225',
						25000, '#723122'];
				}
			}, {
				displayName: 'MLab Unique Upload IPs',
				internalName: 'mlab_ul_count_ips',
				popupFn: mlabPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `ml_ul_count_ips_${timePeriod}`], 100, '#fff',
						500, '#EED322',
						1000, '#E6B71E',
						5000, '#B86B25',
						10000, '#8B4225',
						25000, '#723122'];
				}
			}, {
				displayName: 'FCC Unique Provider Count',
				internalName: 'fcc_provider_count',
				popupFn: fccPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `fcc_provider_count_${timePeriod}`], 0, '#fff',
						1, '#EED322',
						5, '#E6B71E',
						10, '#B86B25',
						25, '#8B4225',
						50, '#723122'];
				}
			}, {
				displayName: 'FCC Advertised Download Speed',
				internalName: 'fcc_advertised_dl',
				popupFn: fccPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `fcc_advertised_down_${timePeriod}`], -Infinity, '#fff',
						0.2, '#ffff5e',
						4, '#EED322',
						10, '#E6B71E',
						25, '#B86B25',
						50, '#8B4225',
						100, '#723122'];
				}
			}, {
				displayName: 'FCC Advertised Upload Speed',
				internalName: 'fcc_advertised_ul',
				popupFn: fccPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return ['interpolate', ['linear'], ['get', `fcc_advertised_up_${timePeriod}`], -Infinity, '#fff',
						0.2, '#ffff91',
						1, '#ffff5e',
						3, '#EED322',
						5, '#E6B71E',
						10, '#B86B25',
						25, '#8B4225',
						50, '#723122'];
				}
			}, {
				displayName: 'Download Comparison (FCC - MLab)',
				internalName: 'mlab_fcc_dl_comp',
				popupFn: diffPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return [
						'interpolate',
						['linear'],
						['-', ['get', `fcc_advertised_down_${timePeriod}`], ['get', `ml_download_Mbps_${timePeriod}`]],
						-Infinity, '#8c510a',
						-25, '#8c510a',
						-15, '#bf812d',
						-10, '#dfc27d',
						-5, '#f6e8c3',
						-1, '#f5f5f5',
							1, '#c7eae5',
							5, '#80cdc1',
							10, '#35978f',
							15, '#01665e',
							25, '#003b34'
					];
				}
			}, {
				displayName: 'Upload Comparison (FCC - MLab)',
				internalName: 'mlab_fcc_ul_comp',
				popupFn: diffPopupFn,
				mapboxGlStyleFn(timePeriod) {
					return [
						'interpolate',
						['linear'],
						['-', ['get', `fcc_advertised_up_${timePeriod}`], ['get', `ml_upload_Mbps_${timePeriod}`]],
						-Infinity, '#8c510a',
						-25, '#8c510a',
						-15, '#bf812d',
						-10, '#dfc27d',
						-5, '#f6e8c3',
						-1, '#f5f5f5',
							1, '#c7eae5',
							5, '#80cdc1',
							10, '#35978f',
							15, '#01665e',
							25, '#003b34'];
				}
			}
			]
	};

// function makeColorRamp(){
		
// 		var measureGroup = document.getElementById('measurement');
// 		var dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;
// 		var measure = document.getElementById('measurement').value;
// 		var state = document.getElementById('state_select').value;
// 		var time_period = time_periods[document.getElementById('slider').value];
// 		var field;
// 		var filter;
		
// 		if( dataset == 'fcc'){
// 			const unsupported_geos = ["congress", "state_house", "state_senate", "zcta"]; 
// 			for (let opt of document.querySelectorAll('select#geo option')) {
// 				opt.disabled = unsupported_geos.includes(opt.value);
// 			}
// 			if (unsupported_geos.includes(document.getElementById('geo').value)) {
// 				document.getElementById('geo').value = 'county';
// 			}
// 			document.getElementById('slider').max = 5;
// 			document.getElementById('slider').value = Math.min(5, document.getElementById('slider').value);		
// 		    time_period = time_periods[document.getElementById('slider').value];
// 			popupTemplate = fccPopupTemplate;
// 			field = ['get', dataset + '_' + measure + time_period[0]];
// 			filter = ['has', dataset + '_' + measure + time_period[0]];
// 		} else if (dataset == 'mlab') {
// 			for (let opt of document.querySelectorAll('select#geo option')) {
// 				opt.disabled = false;
// 			}
// 			field = ['get', 'ml_' + measure + time_period[0]];
// 			filter = ['has', 'ml_' + measure + time_period[0]];
// 			document.getElementById('slider').max = 8;
// 			popupTemplate = mlabPopupTemplate;
// 		} else {
// 			const unsupported_geos = ["congress", "state_house", "state_senate", "zcta"]; 
// 			for (let opt of document.querySelectorAll('select#geo option')) {
// 				opt.disabled = unsupported_geos.includes(opt.value);
// 			}
// 			if (unsupported_geos.includes(document.getElementById('geo').value)) {
// 				document.getElementById('geo').value = 'county';
// 			}
// 			document.getElementById('slider').max = 5;
// 			document.getElementById('slider').value = Math.min(5, document.getElementById('slider').value);		
// 		    time_period = time_periods[document.getElementById('slider').value];
// 			popupTemplate = diffPopupTemplate;
// 			if(measure == 'compare_down_'){
// 				field = ['-', ['get', 'fcc_advertised_down_' + time_period[0]], ['get', 'ml_download_Mbps_' + time_period[0]]];
// 				filter = ['all', ['has', 'fcc_advertised_down_' + time_period[0]], ['has', 'ml_download_Mbps_' + time_period[0]]];
// 			}
// 			else {
// 				field = ['-', ['get', 'fcc_advertised_up_' + time_period[0]], ['get', 'ml_upload_Mbps_' + time_period[0]]];
// 				filter = ['all', ['has', 'fcc_advertised_up_' + time_period[0]], ['has', 'ml_upload_Mbps_' + time_period[0]]];
// 			}
// 		}

// 		var geo_layer = dataset + '_' + document.getElementById('geo').value;


// 		var ramp =	[ 'interpolate',
// 			['linear'],
// 			field,
// 		];

// 		ramp = ramp.concat(ramps[measure]);

// 		//update map colors
// 		map.setPaintProperty(geo_layer,'fill-color',ramp);

// 		var legend_values = ramps[measure];

// 		let cssRamp	= legend_values.filter((_, idx) => idx % 2 != 0).join(',');
// 		cssRamp = `linear-gradient(to right, ${cssRamp})`;
		
//         //update legend colors
// 		document.getElementById('legend').style.background = cssRamp;

//         let cssLabels = [];
//         for(var i=0; i<legend_values.length; i+=2){
//         	cssLabels.push(legend_values[i]);
//         }
// 		cssLabels = cssLabels.filter((breakValue) => Number.isFinite(breakValue));

// 		//update legend values
// 		document.getElementById('legendlabel').innerHTML = cssLabels.map((l) => `<div class="label">${l}</div>`).join('');

// 		//show one layer
// 		for( let lyr of ['mlab_zcta','mlab_census_tract','mlab_state_senate','mlab_state_house','mlab_congress','fcc_census_tract','fcc_county','mlab_nn_state_bills','difference_county','difference_census_tract','mlab_county', 'usbb_zcta']){
// 			map.setLayoutProperty(lyr,'visibility','none');
// 		};
// 		map.setLayoutProperty(geo_layer,'visibility','visible');
		
// 		//filter out nulls
// 		map.setFilter(geo_layer,filter);

// 		// Set the label to the month
// 		document.getElementById('time_period').textContent = time_period[1];
// }
function configureMap() {
	const measure = document.getElementById('measurement').value;
	const geo = document.getElementById('geo').value;
	const timeIndex = document.getElementById('slider').value;
	const timePeriod = config.time_periods[timeIndex];

	const ramp = config.ramps.find((ramp) => ramp.internalName == measure);
	const style = ramp.mapboxGlStyleFn(timePeriod);

	for (const layer of config.geo_units) {
		map.setLayoutProperty(layer[1], 'visibility', layer[1] == geo ? 'visible' : 'none');
		map.setPaintProperty(layer[1], 'fill-color', style);
	}
}

    const measureSelect = document.getElementById('measurement');
	for (const {displayName,internalName} of config.ramps) {
		const opt = document.createElement('option')
		opt.value = internalName;
		opt.innerText = displayName;
		measureSelect.appendChild(opt);
	}
	const geoSelect = document.getElementById('geo');
	for (const [displayName, layerId, src, srcLyr] of config.geo_units) {
		const opt = document.createElement('option');
		opt.value = layerId;
		opt.innerText = displayName;
		geoSelect.appendChild(opt);
	}
	const timeSlider = document.getElementById('slider');
	timeSlider.min = 0;
	timeSlider.max = config.time_periods.length - 1;
	timeSlider.step = 1;
	const stateSelector = document.getElementById('state_select');
	for (const [displayName, mapCoordinates] of config.state_centers) {
		const opt = document.createElement('option');
		opt.value = displayName;
		opt.innerText = displayName;
		stateSelector.appendChild(opt);
	}
	[measureSelect, geoSelect, timeSlider].forEach((el) => el.addEventListener('input', () => {
		configureMap();
	}))
	map.on('load', function () {
		for (const [_, id, url, sourceLayer] of config.geo_units) {
			map.addLayer({
				id,
				type: "fill",
				source: { url, type: "vector" },
				"source-layer": sourceLayer,
				layout: { visibility: 'none' }
			})
		}

		map.addLayer({
			"id": "us_states",
			"type": "line",
			"source": {
				type: 'vector',
				url: 'mapbox://newamerica.cjvopv39u05jt2wmna9mg5wz4-7j8om'
			},
			"layout": {
				'visibility': 'visible'
			},
			"source-layer": "us_states",
			"paint": {
				"line-color": "#000",
				"line-width": 0.5
			}
		});


		// // When a click event occurs on a feature in the states layer, open a popup at the
		// // location of the click, with description HTML from its properties.

		// var popup = new mapboxgl.Popup();

		// map.on('click', function (e) {
		// 	let f = map.queryRenderedFeatures(e.point);
		// 	if (f.length) {
		// 		popup.setLngLat(e.lngLat)
		// 			.setHTML(popupTemplate(f[0].properties))
		// 			.addTo(map);
		// 	}
		// });

		// // Change the cursor to a pointer when the mouse is over the states layer.
		// map.on('mouseenter', 'mlab_county', function () {
		// 	map.getCanvas().style.cursor = 'pointer';
		// });

		// // Change it back to a pointer when it leaves.
		// map.on('mouseleave', 'mlab_county', function () {
		// 	map.getCanvas().style.cursor = '';
		// });


		// // Read settings from URL, if any.
		// // :dataset/:geo/:timeperiod/:measure/:x/:y/:z
		// let fragment = window.location.hash;
		// if (fragment) {
		// 	const check = (v, test) => test(v) ? v : undefined;

		// 	const measureGroup = document.getElementById('measurement');
		// 	const dataset1 = measureGroup.options;
		// 	console.log(dataset1);

		// 	const datasetNames = Array.from(document.querySelectorAll("#data option")).map(el => el.value);
		// 	console.log(datasetNames);

		// 	const geoNames = Array.from(document.querySelectorAll("#geo option")).map(el => el.value);
		// 	const parts = fragment.slice(1).split("/");
		// 	const dataset = check(parts[0], (v) => datasetNames.indexOf(v) >= 0);
		// 	const geo = check(parts[1], (v) => geoNames.indexOf(v) >= 0);
		// 	const timeperiod = check(parts[2], (v) => time_periods.findIndex((x) => x[0] == v) >= 0);
		// 	const measure = check(parts[3], (v) => v in ramps);
		// 	const x = check(Number(parts[4]), (v) => !Number.isNaN(v));
		// 	const y = check(Number(parts[5]), (v) => !Number.isNaN(v));
		// 	const z = check(Number(parts[6]), (v) => !Number.isNaN(v));

		// 	if (dataset) {
		// 		document.querySelector(`#data [value='${dataset}']`).selected = true;
		// 	}
		// 	if (geo) {
		// 		document.querySelector(`#geo [value='${geo}']`).selected = true;
		// 	}
		// 	if (timeperiod !== undefined) {
		// 		document.getElementById('slider').value = time_periods.findIndex((x) => x[0] == timeperiod);
		// 	}
		// 	if (measure) {
		// 		document.querySelector(`#measurement [value='${measure}']`).selected = true;
		// 	}
		// 	if ([x, y, z].every(n => n !== undefined)) {
		// 		map.jumpTo({ center: [x, y], zoom: z });
		// 	}
		// }

		// // Encode the map state into the fragment for linkability.  Keep this in sync with the block above.
		// function updateFragment() {
		// 	var measureGroup = document.getElementById('measurement');
		// 	const dataset = measureGroup.options[measureGroup.selectedIndex].parentNode.id;
		// 	const geo = document.getElementById("geo").value;
		// 	const timeperiod = time_periods[document.getElementById("slider").value][0];
		// 	const measure = document.getElementById("measurement").value;
		// 	const { lng: x, lat: y } = map.getCenter();
		// 	const z = map.getZoom();
		// 	const url = new URL(window.location);
		// 	url.hash = `#${dataset}/${geo}/${timeperiod}/${measure}/${x.toFixed(2)}/${y.toFixed(2)}/${z.toFixed(2)}`;
		// 	window.history.replaceState(undefined, 'USBB', url.toString());
		// }

		// // Run the color ramp to start
		// makeColorRamp();

		// // change things based on selection in the legend
		// document.getElementById('slider').addEventListener('input', function (e) { makeColorRamp(); updateFragment() });
		// document.getElementById('measurement').addEventListener('input', function (e) { makeColorRamp(); updateFragment() });
		// document.getElementById('geo').addEventListener('input', function (e) { makeColorRamp(); updateFragment() });
		// //document.getElementById('data').addEventListener('input', function(e) { makeColorRamp(); updateFragment() });

		// //flyto
		// document.getElementById('state_select').addEventListener('input', function (e) {
		// 	// Fly to a random location by offsetting the point -74.50, 40
		// 	// by up to 5 degrees.

		// 	let active_state = document.getElementById('state_select').value;

		// 	for (var i = 0; i < states_centers.length; i++) {
		// 		// This if statement depends on the format of your array
		// 		if (states_centers[i][0] == active_state) {
		// 			//console.log(states_centers[i][1]);
		// 			fly_to_loc = states_centers[i][1];
		// 		}
		// 	}

		// 	map.flyTo({
		// 		center: [
		// 			fly_to_loc[1] - .25,
		// 			fly_to_loc[0]
		// 		],
		// 		zoom: fly_to_loc[2],
		// 		speed: .5
		// 	});

		// });

		// map.on('moveend', updateFragment);
	});
</script>

</body>
</html>